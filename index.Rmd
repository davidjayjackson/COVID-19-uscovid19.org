---
title: 'USA: COVID-19 Analysis'
author: "David Jackson"
date: "01/31/2021 02:25 PM/EST"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE,warning = FALSE)
library(ggplot2)
library(scales)
library(RSQLite)
library(plotly)
library(dplyr)
library(forecast)
theme_set(theme_linedraw() + theme(panel.grid = element_line(linetype = 'dashed')))

```
```{r}
rm(list=ls())
source("../DATA/movavg.R")
db <- db <- dbConnect(RSQLite::SQLite(),dbname= "../COVID-19-DB/OURWORLD.sqlite3")
df <- dbGetQuery(db,"select * from OWID where location='United States'")
#df <- subset(df,location =="United States"  )
df$date <- as.Date(df$date)
df <- df[order(df$date),]
sum(df$new_cases,na.rm=TRUE)
sum(df$new_deaths,na.rm=TRUE)
```
## US Vaccine Rollout 

```{r}
# vac <- dbGetQuery(db,"select * from OWID where location = 'Spain'")
# vac$date <- as.Date(vac$date)
# vac <- vac[order(vac$date),]
df <- df %>%select(date,location,iso_code,new_cases,new_deaths,new_vaccinations,
                    new_vaccinations_smoothed,total_vaccinations,population)
                    
summary(df$new_vaccinations)
summary(df$new_cases)
summary(df$new_deaths)
```
```{r}
df$CMA <- ma(df$new_cases,7,centre=TRUE)
df$DMA <- ma(df$new_deaths,7,centre=TRUE)
```

```{r}
p5 <- ggplot(df) + geom_line(aes(x=date,y=new_vaccinations)) +
  scale_y_continuous(labels=comma) +
  labs(title="Spain's New Vaccinations By Date") +
  geom_smooth(aes(x=date,y=new_vaccinations))
```
```{r}
p6 <- ggplot(df) + geom_line(aes(x=date,y=total_vaccinations)) +
  scale_y_continuous(labels=comma) +
  labs(title="Spain's Total Vaccinations By Date") 

```

```{r}
df$Rate <- df$total_vaccinations/df$population
p7 <- ggplot(df) + geom_line(aes(x=date,y=Rate)) + 
    scale_y_continuous(labels=percent) +
  labs(title="Spain's vaccination Rate By Day")
ggplotly(p5)
ggplotly(p6)
ggplotly(p7)

```

#### Mortality Rate(Deaths/Cases)

```{r}
df %>% filter(date >="2020-04-05") %>%
  group_by(date) %>% summarise(Rate = new_deaths/new_cases) %>%
  ggplot(aes(x=date,y=Rate)) + geom_line(aes(x=date,y=Rate)) + scale_y_continuous(labels = percent) + geom_smooth(method="loess",span=0.25)
  labs(title="US Daily Mortality Rate", y="Mortality Rate",caption="(Source: John Hopkins/Our World In Data)") 
```


#### Daily COVID-19 Cases

```{r}
plot1 <- df %>% filter(date >="2020-01-24" & new_cases >0) %>%
     ggplot() + geom_col(aes(x=date,y=CMA),) +
    labs(title="USA Daily Cases (W/ 7 day moving average)") + scale_y_continuous(labels=comma)
ggplotly(plot1)
# 
# ggplot(df) + geom_line(aes(x=date,y=CMA,fill="CMA)) + 
#   labs(title="Fourteen Day Moving Average: Case") +
# scale_y_continuous(labels=comma)
```

#### Daily Deaths

```{r}
plot2 <- df %>% filter(date>="2020-02-29" & new_deaths>0) %>%
ggplot() +  geom_col(aes(x=date,y=DMA,fill="Deaths")) +
  labs(title="USA Daily Deaths (7 day moving average") + scale_y_continuous(labels=comma)
ggplotly(plot2)

# ggplot(df) + geom_line(aes(x=date,y=DMA),col="red") + 
#   labs(title="Fourteen Day Moving Average: Deaths")
  
```

#### Non-Moving Average By Week and By Month

```{r}
df$Monthly <- as.Date(cut(df$date,
  breaks = "month"))
df$Weekly <- as.Date(cut(df$date,
  breaks = "week",
  start.on.monday = FALSE))

```
```{r}
Weekly_new_cases <- aggregate(new_cases~Weekly,df,FUN=sum)
Weekly_new_deaths <- aggregate(new_deaths~Weekly,df,FUN=sum)
Weekly_new_cases$DRate <- Weekly_new_deaths$new_deaths/Weekly_new_cases$new_cases

```
```{r}
ggplot(Weekly_new_cases) + geom_col(aes(x=Weekly,y=new_cases)) + 
  labs(title="Weekly new_cases",x="date date", y="Weekly Cases") +
  geom_hline(yintercept = mean(Weekly_new_cases$new_cases),col="red",lwd=1.5) +
  scale_y_continuous(labels = scales::comma) 


ggplot(Weekly_new_deaths) + geom_col(aes(x=Weekly,y=new_deaths)) + 
  labs(title="Weekly Deaths",x="date date", y="Weekly new_deaths") +
  scale_y_continuous(labels = scales::comma) +
  geom_hline(yintercept = mean(Weekly_new_deaths$new_deaths),col="red",lwd=1.5)
``` 

#### Monthly new_cases and new_deaths

```{r}

Monthly_new_cases <- aggregate(new_cases~Monthly,df,FUN=sum)
Monthly_new_deaths <- aggregate(new_deaths~Monthly,df,FUN=sum)
Monthly_new_cases$DRate <- Monthly_new_deaths$new_deaths/Monthly_new_cases$new_cases

```
```{r}
ggplot(Monthly_new_cases) + geom_col(aes(x=Monthly,y=new_cases)) +
  labs(title="Monthly Cases") +
  scale_y_continuous(labels = scales::comma)

ggplot(Monthly_new_deaths) + geom_col(aes(x=Monthly,y=new_deaths)) +
  labs(title="Monthly Deaths") +
  scale_y_continuous(labels = scales::comma)
```

